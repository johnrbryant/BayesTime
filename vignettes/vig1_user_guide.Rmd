---
title: "vig1_user_guide"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vig1_user_guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(BayesRates)
library(dplyr)
library(ggplot2)
```

## Smoothing by across age

```{r}
divorce_2020 <- nz_divorces %>%
  filter(time == 2020) %>%
  select(-time)
popn_2020 <- nz_population %>%
  filter(time == 2020) %>%
  select(-time)

res_age <- smooth_age(nevent_df = divorce_2020,
                      py_df = popn_2020)
res_age
```

```{r}
components(res_age, what = "rates")
```

```{r}
components(res_age, what = "age_effect")
```


```{r}
rates_age_df <- augment(res_age)
rates_age_df
```

```{r}
ggplot(rates_age_df, aes(x = age)) +
  facet_wrap(vars(sex)) +
  geom_pointrange(aes(ymin = .lower, y = .fitted, ymax = .upper)) +
  geom_point(aes(y = .observed), col = "blue")
```

## Smoothing across age and time


```{r}
res_agetime <- smooth_agetime(nevent_df = nz_divorces,
                              py_df = nz_population,
                              byvar = "sex")
```


```{r}
rates_agetime_df <- augment(res_agetime)
```

```{r, fig.width = 7, fig.height = 7}
ggplot(rates_agetime_df, aes(x = time)) +
  facet_wrap(vars(age)) +
  geom_ribbon(aes(ymin = .lower, ymax = .upper, fill = sex),
              alpha = 0.6) +
  geom_line(aes(y = .fitted, color = sex)) +
  geom_point(aes(y = .observed, color = sex),
             size = 0.25)
```


```{r}
age_effect <- components(res_agetime, what = "age_effect")
ggplot(age_effect, aes(x = age)) +
  facet_wrap(vars(sex)) +
  geom_pointrange(aes(ymin = .lower, y = .fitted, ymax = .upper))
```

```{r}
time_effect <- components(res_agetime, what = "time_effect") 
head(time_effect)
```

```{r}
ggplot(time_effect, aes(x = time, y = .fitted, color = sex)) +
  facet_wrap(vars(age)) +
  geom_line(aes(y = .fitted))
```

