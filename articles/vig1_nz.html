<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Divorces in New Zealand • BayesRates</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Divorces in New Zealand">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">BayesRates</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/vig1_nz.html">Divorces in New Zealand</a></li>
    <li><a class="dropdown-item" href="../articles/vig2_cn.html">Divorces in China</a></li>
    <li><a class="dropdown-item" href="../articles/vig3_math.html">vig3_math</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Divorces in New Zealand</h1>
            
      

      <div class="d-none name"><code>vig1_nz.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette we use <strong>BayesRates</strong> to calculate
age-specific rates and turn these age-specific rates into total divorce
rates. We use administrative data on divorce in New Zealand in New
Zealand. The counts of divorce and population in the dataset are large,
so sampling errors are small.</p>
</div>
<div class="section level2">
<h2 id="preliminaries">Preliminaries<a class="anchor" aria-label="anchor" href="#preliminaries"></a>
</h2>
<div class="section level3">
<h3 id="packages">Packages<a class="anchor" aria-label="anchor" href="#packages"></a>
</h3>
<p>Besides <strong>BayesRates</strong> we load <strong>dplyr</strong>,
for data manipulation, and <strong>ggplot</strong> for plotting.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://junnizhang.github.io/BayesRates/">BayesRates</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in get(paste0(generic, ".", class), envir = get_method_env()) : </span></span>
<span><span class="co">#&gt;   object 'type_sum.accel' not found</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>The data on divorces is ins <code>nz_divorces</code>, a data frame
contained in the <strong>BayesRates</strong> package. `nz_divorces has
four columns:</p>
<ul>
<li>
<code>age</code>: a factor with levels
<code>"15-19"</code>,<code>"20-24"</code>,…,<code>"60-64"</code>,<code>"65+"</code>;<br>
</li>
<li>
<code>sex</code>: a character vector with values
<code>"Female"</code> and <code>"Male"</code>;<br>
</li>
<li>
<code>time</code>: an integer vector with values
<code>1992</code>,…,<code>2021</code>; and</li>
<li>
<code>nevent</code>: a numeric vector with the number of
divorces.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nz_divorces</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 660 × 4</span></span></span>
<span><span class="co">#&gt;    age   sex     time nevent</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 15-19 Female  <span style="text-decoration: underline;">1</span>992     12</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 15-19 Female  <span style="text-decoration: underline;">1</span>993      6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 15-19 Female  <span style="text-decoration: underline;">1</span>994      9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 15-19 Female  <span style="text-decoration: underline;">1</span>995      6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 15-19 Female  <span style="text-decoration: underline;">1</span>996      3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 15-19 Female  <span style="text-decoration: underline;">1</span>997      9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 15-19 Female  <span style="text-decoration: underline;">1</span>998      3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 15-19 Female  <span style="text-decoration: underline;">1</span>999      6</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 15-19 Female  <span style="text-decoration: underline;">2</span>000      9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 15-19 Female  <span style="text-decoration: underline;">2</span>001      6</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 650 more rows</span></span></span></code></pre></div>
<p>The data on population is in <code>nz_population</code>, also
contained in the <strong>BayesRates</strong> package.
<code>nz_population</code> has with four columns:</p>
<ul>
<li>
<code>age</code>: a factor with levels
<code>"15-19"</code>,<code>"20-24"</code>,…,<code>"60-64"</code>,<code>"65+"</code>;<br>
</li>
<li>
<code>sex</code>: a character vector with values
<code>"Female"</code>, <code>"Male"</code>;<br>
</li>
<li>
<code>time</code>: an integer vector with values being
<code>1992</code>,…,<code>2021</code>; and</li>
<li>
<code>py</code>: a numeric vector with person-years of
exposure.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nz_population</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 660 × 4</span></span></span>
<span><span class="co">#&gt;    age   sex     time     py</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 15-19 Female  <span style="text-decoration: underline;">1</span>992 <span style="text-decoration: underline;">139</span>500</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 15-19 Female  <span style="text-decoration: underline;">1</span>993 <span style="text-decoration: underline;">135</span>510</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 15-19 Female  <span style="text-decoration: underline;">1</span>994 <span style="text-decoration: underline;">133</span>010</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 15-19 Female  <span style="text-decoration: underline;">1</span>995 <span style="text-decoration: underline;">131</span>960</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 15-19 Female  <span style="text-decoration: underline;">1</span>996 <span style="text-decoration: underline;">132</span>490</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 15-19 Female  <span style="text-decoration: underline;">1</span>997 <span style="text-decoration: underline;">132</span>590</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 15-19 Female  <span style="text-decoration: underline;">1</span>998 <span style="text-decoration: underline;">133</span>050</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 15-19 Female  <span style="text-decoration: underline;">1</span>999 <span style="text-decoration: underline;">133</span>210</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 15-19 Female  <span style="text-decoration: underline;">2</span>000 <span style="text-decoration: underline;">134</span>360</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 15-19 Female  <span style="text-decoration: underline;">2</span>001 <span style="text-decoration: underline;">136</span>360</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 650 more rows</span></span></span></code></pre></div>
<p>The person-years of exposure, and hence the number of divorces, are
both quite large.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nz_population</span><span class="op">$</span><span class="va">py</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;   68470  130178  145890  151497  160290  434780</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nz_divorces</span><span class="op">$</span><span class="va">nevent</span><span class="op">)</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt;     0.0   282.0   769.5   827.7  1329.0  2079.0</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="rates-in-a-single-period-both-sexes-combined">Rates in a single period, both sexes combined<a class="anchor" aria-label="anchor" href="#rates-in-a-single-period-both-sexes-combined"></a>
</h2>
<p>We start with the relatively simple where we are estimating
age-specific rates in a single period, not distinguishing between
females and males.</p>
<p>As a first step, we create two new datasets each only containing data
for 2020.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nz_divorce_2020</span> <span class="op">&lt;-</span> <span class="va">nz_divorces</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">time</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nz_popn_2020</span> <span class="op">&lt;-</span> <span class="va">nz_population</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">time</span><span class="op">)</span></span></code></pre></div>
<p>We use the <code><a href="../reference/smooth_age.html">smooth_age()</a></code> function to smooth the observed
across age.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_age.html">smooth_age</a></span><span class="op">(</span>nevent_df <span class="op">=</span> <span class="va">nz_divorce_2020</span>,</span>
<span>                      py_df <span class="op">=</span> <span class="va">nz_popn_2020</span>,</span>
<span>                      age_width_df <span class="op">=</span> <span class="va">nz_age_width_df</span>,</span>
<span>                      age_min <span class="op">=</span> <span class="fl">15</span><span class="op">)</span></span></code></pre></div>
<p>In the call to <code><a href="../reference/smooth_age.html">smooth_age()</a></code>, the parameter
<code>nevent_df</code> specifies the data frame for numbers of events,
and the parameter <code>py_df</code> specifies the data frame for person
years of exposure. The parameters <code>age_width_df</code> and
<code>age_min</code> provide information about age groups.
<code>nz_age_width_df</code> is an existing data frame in the
<strong>BayesRates</strong> package that gives the width of each age
group.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">nz_age_width_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 2</span></span></span>
<span><span class="co">#&gt;   age   width</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 15-19     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 20-24     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 25-29     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 30-34     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 35-39     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 40-44     5</span></span></code></pre></div>
<p>We have not told <code><a href="../reference/smooth_age.html">smooth_age()</a></code> to calculate separate
rates for females and males, so, before fitting, it aggregates events
and person-years across the sexes.</p>
<p>A summary of the model specification can be obtained by printing the
return value from <code><a href="../reference/smooth_age.html">smooth_age()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_age</span></span>
<span><span class="co">#&gt; --- Object of class "BayesRates_results" ---</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      nevent ~ Poisson(rate * py)</span></span>
<span><span class="co">#&gt;   log(rate) = age_effect</span></span>
<span><span class="co">#&gt;  age_effect ~ Spline()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    agevar: age</span></span>
<span><span class="co">#&gt;     byvar: &lt;none&gt;</span></span>
<span><span class="co">#&gt;    n_draw: 1000</span></span></code></pre></div>
<p>The number of events is modeled by a Poisson distribution with mean
equal to an underlying rate multiplied by person-years of exposure. The
logarithm of the underlying rate equals the age effect, which is modeled
by a spline model. The model for the age effect is
<code><a href="../reference/Spline.html">Spline()</a></code>. The value for <code>agevar</code> is
<code>"age"</code>, indicating that variable with information on age
groups is called <code>"age"</code>. The value of <code>byvar</code> is
empty, indicating that we fit a single model, within everyone belonging
to the same group. The value of <code>ndraw</code> is 1000, indicating
that the number of posterior draws is 1000, the default.</p>
<p>We use the <code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code> function to extract model-based
estimates of rates disaggregated by age.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="va">res_age</span>, what <span class="op">=</span> <span class="st">"rates"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 11 × 6</span></span></span>
<span><span class="co">#&gt;    age   age.mid   .fitted    .lower    .upper .probability </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 15-19    17.5 0.000<span style="text-decoration: underline;">020</span>1 0.000<span style="text-decoration: underline;">010</span>6 0.000<span style="text-decoration: underline;">038</span>8 <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 20-24    22.5 0.000<span style="text-decoration: underline;">495</span>  0.000<span style="text-decoration: underline;">434</span>  0.000<span style="text-decoration: underline;">564</span>  <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 25-29    27.5 0.002<span style="text-decoration: underline;">66</span>   0.002<span style="text-decoration: underline;">53</span>   0.002<span style="text-decoration: underline;">80</span>   <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 30-34    32.5 0.005<span style="text-decoration: underline;">23</span>   0.005<span style="text-decoration: underline;">04</span>   0.005<span style="text-decoration: underline;">42</span>   <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 35-39    37.5 0.006<span style="text-decoration: underline;">29</span>   0.006<span style="text-decoration: underline;">10</span>   0.006<span style="text-decoration: underline;">51</span>   <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 40-44    42.5 0.007<span style="text-decoration: underline;">02</span>   0.006<span style="text-decoration: underline;">84</span>   0.007<span style="text-decoration: underline;">22</span>   <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 45-49    47.5 0.007<span style="text-decoration: underline;">24</span>   0.007<span style="text-decoration: underline;">02</span>   0.007<span style="text-decoration: underline;">48</span>   <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 50-54    52.5 0.006<span style="text-decoration: underline;">38</span>   0.006<span style="text-decoration: underline;">18</span>   0.006<span style="text-decoration: underline;">58</span>   <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 55-59    57.5 0.004<span style="text-decoration: underline;">95</span>   0.004<span style="text-decoration: underline;">75</span>   0.005<span style="text-decoration: underline;">13</span>   <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 60-64    62.5 0.003<span style="text-decoration: underline;">26</span>   0.003<span style="text-decoration: underline;">07</span>   0.003<span style="text-decoration: underline;">46</span>   <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> 65+      72.5 0.001<span style="text-decoration: underline;">21</span>   0.001<span style="text-decoration: underline;">14</span>   0.001<span style="text-decoration: underline;">30</span>   <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span></code></pre></div>
<p><code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code> returns a data frame. In this data
frame,</p>
<ul>
<li>
<code>age.mid</code> gives the middle point for each age group
(which is helpful for plotting);</li>
<li>
<code>.fitted</code> gives a point estimate of the rate;</li>
<li>
<code>.lower</code> and <code>.upper</code> give lower and upper
bounds of the credible interval of the rate (a 95% credible interval by
default); and</li>
<li>
<code>.probability</code> gives a list containing the posterior
draws of the rate.</li>
</ul>
<p><code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code> can also be used to extract model-based
estimates of age effects:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="va">res_age</span>, what <span class="op">=</span> <span class="st">"age_effect"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 11 × 6</span></span></span>
<span><span class="co">#&gt;    age   age.mid .fitted .lower .upper .probability </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 15-19    17.5  -<span style="color: #BB0000;">4.69</span>  -<span style="color: #BB0000;">5.27</span>  -<span style="color: #BB0000;">4.10</span>  <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 20-24    22.5  -<span style="color: #BB0000;">1.49</span>  -<span style="color: #BB0000;">1.60</span>  -<span style="color: #BB0000;">1.37</span>  <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 25-29    27.5   0.195  0.109  0.275 <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 30-34    32.5   0.871  0.799  0.942 <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 35-39    37.5   1.06   0.988  1.13  <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 40-44    42.5   1.16   1.10   1.24  <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 45-49    47.5   1.20   1.13   1.27  <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 50-54    52.5   1.07   1.00   1.14  <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 55-59    57.5   0.816  0.743  0.886 <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 60-64    62.5   0.400  0.313  0.489 <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> 65+      72.5  -<span style="color: #BB0000;">0.587</span> -<span style="color: #BB0000;">0.677</span> -<span style="color: #BB0000;">0.502</span> <span style="color: #949494;">&lt;dbl [1,000]&gt;</span></span></span></code></pre></div>
<p>Function <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> returns the original data plus
model-based estimates of rates.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rates_age_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">res_age</span><span class="op">)</span></span>
<span><span class="va">rates_age_df</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 22 × 10</span></span></span>
<span><span class="co">#&gt;    age   sex    nevent     py age.mid   .fitted    .lower    .upper .probability</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 15-19 Female      0 <span style="text-decoration: underline;">154</span>480    17.5 0.000<span style="text-decoration: underline;">020</span>1 0.000<span style="text-decoration: underline;">010</span>6 0.000<span style="text-decoration: underline;">038</span>8 <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 15-19 Male        0 <span style="text-decoration: underline;">162</span>910    17.5 0.000<span style="text-decoration: underline;">020</span>1 0.000<span style="text-decoration: underline;">010</span>6 0.000<span style="text-decoration: underline;">038</span>8 <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 20-24 Female    111 <span style="text-decoration: underline;">163</span>370    22.5 0.000<span style="text-decoration: underline;">495</span>  0.000<span style="text-decoration: underline;">434</span>  0.000<span style="text-decoration: underline;">564</span>  <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 20-24 Male       54 <span style="text-decoration: underline;">175</span>600    22.5 0.000<span style="text-decoration: underline;">495</span>  0.000<span style="text-decoration: underline;">434</span>  0.000<span style="text-decoration: underline;">564</span>  <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 25-29 Female    639 <span style="text-decoration: underline;">187</span>000    27.5 0.002<span style="text-decoration: underline;">66</span>   0.002<span style="text-decoration: underline;">53</span>   0.002<span style="text-decoration: underline;">80</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 25-29 Male      429 <span style="text-decoration: underline;">195</span>310    27.5 0.002<span style="text-decoration: underline;">66</span>   0.002<span style="text-decoration: underline;">53</span>   0.002<span style="text-decoration: underline;">80</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 30-34 Female   <span style="text-decoration: underline;">1</span>026 <span style="text-decoration: underline;">187</span>220    32.5 0.005<span style="text-decoration: underline;">23</span>   0.005<span style="text-decoration: underline;">04</span>   0.005<span style="text-decoration: underline;">42</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 30-34 Male      837 <span style="text-decoration: underline;">186</span>170    32.5 0.005<span style="text-decoration: underline;">23</span>   0.005<span style="text-decoration: underline;">04</span>   0.005<span style="text-decoration: underline;">42</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 35-39 Female   <span style="text-decoration: underline;">1</span>134 <span style="text-decoration: underline;">168</span>560    37.5 0.006<span style="text-decoration: underline;">29</span>   0.006<span style="text-decoration: underline;">10</span>   0.006<span style="text-decoration: underline;">51</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 35-39 Male     <span style="text-decoration: underline;">1</span>032 <span style="text-decoration: underline;">165</span>880    37.5 0.006<span style="text-decoration: underline;">29</span>   0.006<span style="text-decoration: underline;">10</span>   0.006<span style="text-decoration: underline;">51</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 12 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: .observed &lt;dbl&gt;</span></span></span></code></pre></div>
<p>Since the model does not distinguish sexes, the values of ‘.fitted’,
‘.lower’, ‘.upper’ and ‘.probability’ are the same for females and males
at the each age.</p>
<p>We plot the model-based estimates of rates (including point estimates
and credible intervals) and the observed rates (in blue), separately for
each sex.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rates_age_df</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age.mid</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, y <span class="op">=</span> <span class="va">.fitted</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"salmon"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig1_nz_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>Function <code><a href="../reference/total_rate.html">total_rate()</a></code> sums across ages to give total
rates.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/total_rate.html">total_rate</a></span><span class="op">(</span><span class="va">res_age</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 5</span></span></span>
<span><span class="co">#&gt;   .fitted .lower .upper .probability  .observed</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>   0.236  0.232  0.239 <span style="color: #949494;">&lt;dbl [1,000]&gt;</span>     0.236</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="rates-in-a-single-period-separating-sexes">Rates in a single period, separating sexes<a class="anchor" aria-label="anchor" href="#rates-in-a-single-period-separating-sexes"></a>
</h2>
<p>We next fit a separate model for each sex. To do this, we set the
argument <code>byvar</code> in <code><a href="../reference/smooth_age.html">smooth_age()</a></code> to
<code>"sex"</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_age_bysex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_age.html">smooth_age</a></span><span class="op">(</span>nevent_df <span class="op">=</span> <span class="va">nz_divorce_2020</span>,</span>
<span>                            py_df <span class="op">=</span> <span class="va">nz_popn_2020</span>,</span>
<span>                            age_width_df <span class="op">=</span> <span class="va">nz_age_width_df</span>,</span>
<span>                            age_min <span class="op">=</span> <span class="fl">15</span>,</span>
<span>                            byvar <span class="op">=</span> <span class="st">"sex"</span><span class="op">)</span></span>
<span><span class="va">res_age_bysex</span></span>
<span><span class="co">#&gt; --- Object of class "BayesRates_results" ---</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      nevent ~ Poisson(rate * py)</span></span>
<span><span class="co">#&gt;   log(rate) = age_effect</span></span>
<span><span class="co">#&gt;  age_effect ~ Spline()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    agevar: age</span></span>
<span><span class="co">#&gt;     byvar: sex</span></span>
<span><span class="co">#&gt;    n_draw: 1000</span></span></code></pre></div>
<p>The rates returned by <code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code> now distinguish between
sexes</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rates_age_bysex_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">res_age_bysex</span><span class="op">)</span></span>
<span><span class="va">rates_age_bysex_df</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 22 × 10</span></span></span>
<span><span class="co">#&gt;    age   sex    nevent     py age.mid   .fitted    .lower    .upper .probability</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 15-19 Female      0 <span style="text-decoration: underline;">154</span>480    17.5 0.000<span style="text-decoration: underline;">036</span>4 0.000<span style="text-decoration: underline;">018</span>9 0.000<span style="text-decoration: underline;">068</span>2 <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 15-19 Male        0 <span style="text-decoration: underline;">162</span>910    17.5 0.000<span style="text-decoration: underline;">022</span>0 0.000<span style="text-decoration: underline;">011</span>1 0.000<span style="text-decoration: underline;">041</span>3 <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 20-24 Female    111 <span style="text-decoration: underline;">163</span>370    22.5 0.000<span style="text-decoration: underline;">674</span>  0.000<span style="text-decoration: underline;">568</span>  0.000<span style="text-decoration: underline;">787</span>  <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 20-24 Male       54 <span style="text-decoration: underline;">175</span>600    22.5 0.000<span style="text-decoration: underline;">326</span>  0.000<span style="text-decoration: underline;">266</span>  0.000<span style="text-decoration: underline;">409</span>  <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 25-29 Female    639 <span style="text-decoration: underline;">187</span>000    27.5 0.003<span style="text-decoration: underline;">22</span>   0.003<span style="text-decoration: underline;">01</span>   0.003<span style="text-decoration: underline;">45</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 25-29 Male      429 <span style="text-decoration: underline;">195</span>310    27.5 0.002<span style="text-decoration: underline;">04</span>   0.001<span style="text-decoration: underline;">89</span>   0.002<span style="text-decoration: underline;">21</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 30-34 Female   <span style="text-decoration: underline;">1</span>026 <span style="text-decoration: underline;">187</span>220    32.5 0.005<span style="text-decoration: underline;">78</span>   0.005<span style="text-decoration: underline;">53</span>   0.006<span style="text-decoration: underline;">07</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 30-34 Male      837 <span style="text-decoration: underline;">186</span>170    32.5 0.004<span style="text-decoration: underline;">72</span>   0.004<span style="text-decoration: underline;">49</span>   0.004<span style="text-decoration: underline;">96</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 35-39 Female   <span style="text-decoration: underline;">1</span>134 <span style="text-decoration: underline;">168</span>560    37.5 0.006<span style="text-decoration: underline;">53</span>   0.006<span style="text-decoration: underline;">22</span>   0.006<span style="text-decoration: underline;">84</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 35-39 Male     <span style="text-decoration: underline;">1</span>032 <span style="text-decoration: underline;">165</span>880    37.5 0.006<span style="text-decoration: underline;">09</span>   0.005<span style="text-decoration: underline;">78</span>   0.006<span style="text-decoration: underline;">40</span>   <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 12 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: .observed &lt;dbl&gt;</span></span></span></code></pre></div>
<p>Graphing the results shows that the model now recognizes the
female-male differences in age patterns.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rates_age_bysex_df</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age.mid</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, y <span class="op">=</span> <span class="va">.fitted</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"salmon"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig1_nz_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
<p>Function <code><a href="../reference/total_rate.html">total_rate()</a></code> now produces separate results for
females and males.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/total_rate.html">total_rate</a></span><span class="op">(</span><span class="va">res_age_bysex</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">#&gt;   sex    .fitted .lower .upper .probability  .observed</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Female   0.231  0.227  0.237 <span style="color: #949494;">&lt;dbl [1,000]&gt;</span>     0.232</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Male     0.242  0.237  0.248 <span style="color: #949494;">&lt;dbl [1,000]&gt;</span>     0.242</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="alternative-specifications-of-age-effect">Alternative specifications of age effect<a class="anchor" aria-label="anchor" href="#alternative-specifications-of-age-effect"></a>
</h2>
<p>The <code>spec_age</code> argument to <code><a href="../reference/smooth_age.html">smooth_age()</a></code>
specifies the prior model to be applied to age effects. The default
value for <code>spec_age</code> is <code><a href="../reference/Spline.html">Spline()</a></code>. In this
section we experiment with alternative values.</p>
<div class="section level3">
<h3 id="modifying-the-spline-model-for-age-effects">Modifying the spline model for age effects<a class="anchor" aria-label="anchor" href="#modifying-the-spline-model-for-age-effects"></a>
</h3>
<p>When <code>spec_age</code> is set to <code><a href="../reference/Spline.html">Spline()</a></code>, age
effects are modelled using a penalised spline, with degrees of freedom
equal to <code>max(ceiling(0.7 * n), 4)</code>, where <code>n</code> is
the number of age groups. In our data, <code>n</code> equals 11, so the
degrees of freedom is 8.</p>
<p>Reducing the degrees of freedom used within <code><a href="../reference/Spline.html">Spline()</a></code> may
lead smoother age effects. Here we set the degrees of freedom to
<code>5</code>, and graph the results.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_age_bysex_5df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_age.html">smooth_age</a></span><span class="op">(</span>nevent_df <span class="op">=</span> <span class="va">nz_divorce_2020</span>,</span>
<span>                                py_df <span class="op">=</span> <span class="va">nz_popn_2020</span>,</span>
<span>                                age_width_df <span class="op">=</span> <span class="va">nz_age_width_df</span>,</span>
<span>                                age_min <span class="op">=</span> <span class="fl">15</span>,</span>
<span>                                byvar <span class="op">=</span> <span class="st">"sex"</span>,</span>
<span>                                spec_age <span class="op">=</span> <span class="fu"><a href="../reference/Spline.html">Spline</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rates_age_bysex_5df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">res_age_bysex_5df</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rates_age_bysex_5df</span>,</span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age.mid</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, y <span class="op">=</span> <span class="va">.fitted</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"salmon"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig1_nz_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
<p>The lower degrees of freedom does indeed increase the smoothing, and
the modelled estimates are further away from the direct estimates.</p>
</div>
<div class="section level3">
<h3 id="second-order-random-walk-model-for-age">Second-order random walk model for age<a class="anchor" aria-label="anchor" href="#second-order-random-walk-model-for-age"></a>
</h3>
<p>We can also use a second order random walk model to smooth the
observed rates across age for each sex.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_age_bysex_rw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_age.html">smooth_age</a></span><span class="op">(</span>nevent_df <span class="op">=</span> <span class="va">nz_divorce_2020</span>,</span>
<span>                               py_df <span class="op">=</span> <span class="va">nz_popn_2020</span>,</span>
<span>                               age_width_df <span class="op">=</span> <span class="va">nz_age_width_df</span>,</span>
<span>                               age_min <span class="op">=</span> <span class="fl">15</span>,</span>
<span>                               byvar <span class="op">=</span> <span class="st">"sex"</span>,</span>
<span>                               spec_age <span class="op">=</span> <span class="fu"><a href="../reference/RW2.html">RW2</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rates_age_bysex_rw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">res_age_bysex_rw</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rates_age_bysex_rw</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age.mid</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, y <span class="op">=</span> <span class="va">.fitted</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"salmon"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig1_nz_files/figure-html/unnamed-chunk-19-1.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="smoothing-over-age-and-time">Smoothing over age and time<a class="anchor" aria-label="anchor" href="#smoothing-over-age-and-time"></a>
</h2>
<p>We now return to the full dataset, and apply function
<code><a href="../reference/smooth_agetime.html">smooth_agetime()</a></code>, which simultaneously smooths over age and
time.</p>
<div class="section level3">
<h3 id="fixed-age-pattern">Fixed age pattern<a class="anchor" aria-label="anchor" href="#fixed-age-pattern"></a>
</h3>
<p>In our first model, we asssume that age-patterns are constant over
time. We set the parameter <code>spec_time</code> to
<code><a href="../reference/TimeFixed.html">TimeFixed()</a></code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_agetime_fix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_agetime.html">smooth_agetime</a></span><span class="op">(</span>nevent_df <span class="op">=</span> <span class="va">nz_divorces</span>,</span>
<span>                                  py_df <span class="op">=</span> <span class="va">nz_population</span>,</span>
<span>                                  age_width_df <span class="op">=</span> <span class="va">nz_age_width_df</span>,</span>
<span>                                  age_min <span class="op">=</span> <span class="fl">15</span>,</span>
<span>                                  byvar <span class="op">=</span> <span class="st">"sex"</span>,</span>
<span>                          spec_time <span class="op">=</span> <span class="fu"><a href="../reference/TimeFixed.html">TimeFixed</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res_agetime_fix</span></span>
<span><span class="co">#&gt; --- Object of class "BayesRates_results" ---</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      nevent ~ Poisson(rate * py)</span></span>
<span><span class="co">#&gt;   log(rate) = age_effect + time_effect</span></span>
<span><span class="co">#&gt;  age_effect ~ Spline()</span></span>
<span><span class="co">#&gt; time_effect ~ TimeFixed()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    agevar: age</span></span>
<span><span class="co">#&gt;   timevar: time</span></span>
<span><span class="co">#&gt;     byvar: sex</span></span>
<span><span class="co">#&gt;    n_draw: 1000</span></span></code></pre></div>
<p>The model outputs now have a time dimension.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rates_agetime_fix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">res_agetime_fix</span><span class="op">)</span></span>
<span><span class="va">rates_agetime_fix</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 660 × 11</span></span></span>
<span><span class="co">#&gt;    age   sex     time nevent     py age.mid .fitted  .lower  .upper .probability</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 15-19 Female  <span style="text-decoration: underline;">1</span>992     12 <span style="text-decoration: underline;">139</span>500    17.5 3.56<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 3.03<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 4.21<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 15-19 Female  <span style="text-decoration: underline;">1</span>993      6 <span style="text-decoration: underline;">135</span>510    17.5 3.53<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 3.02<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 4.15<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 15-19 Female  <span style="text-decoration: underline;">1</span>994      9 <span style="text-decoration: underline;">133</span>010    17.5 3.47<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 2.97<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 4.08<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 15-19 Female  <span style="text-decoration: underline;">1</span>995      6 <span style="text-decoration: underline;">131</span>960    17.5 3.52<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 3.01<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 4.13<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 15-19 Female  <span style="text-decoration: underline;">1</span>996      3 <span style="text-decoration: underline;">132</span>490    17.5 3.59<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 3.06<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 4.20<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 15-19 Female  <span style="text-decoration: underline;">1</span>997      9 <span style="text-decoration: underline;">132</span>590    17.5 3.43<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 2.95<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 4.04<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 15-19 Female  <span style="text-decoration: underline;">1</span>998      3 <span style="text-decoration: underline;">133</span>050    17.5 3.50<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 2.98<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 4.11<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 15-19 Female  <span style="text-decoration: underline;">1</span>999      6 <span style="text-decoration: underline;">133</span>210    17.5 3.41<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 2.91<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 4.00<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 15-19 Female  <span style="text-decoration: underline;">2</span>000      9 <span style="text-decoration: underline;">134</span>360    17.5 3.31<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 2.82<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 3.88<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 15-19 Female  <span style="text-decoration: underline;">2</span>001      6 <span style="text-decoration: underline;">136</span>360    17.5 3.28<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 2.82<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> 3.88<span style="color: #949494;">e</span><span style="color: #BB0000;">-5</span> <span style="color: #949494;">&lt;dbl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 650 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: .observed &lt;dbl&gt;</span></span></span></code></pre></div>
<p>When we graph the results for the period 1992–2021, we see systematic
differences between the modelled and direct estimates.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rates_agetime_fix</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age.mid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span>, fill <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>,</span>
<span>              alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted</span>, color <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span>, color <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig1_nz_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
<p>These results suggest that we may need to allow the age-pattern to
vary over time.</p>
</div>
<div class="section level3">
<h3 id="time-varying-age-pattern">Time-varying age pattern<a class="anchor" aria-label="anchor" href="#time-varying-age-pattern"></a>
</h3>
<p>To allow the age-pattern to vary over time, we set
<code>spec_time</code> to <code><a href="../reference/TimeVarying.html">TimeVarying()</a></code>, which is in fact
the default. In the <code><a href="../reference/TimeVarying.html">TimeVarying()</a></code> model, each age group
follows a different random walk, with the random walks for neighbouring
age groups being more highly correlated than random walks for distant
age groups.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_agetime_vary</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_agetime.html">smooth_agetime</a></span><span class="op">(</span>nevent_df <span class="op">=</span> <span class="va">nz_divorces</span>,</span>
<span>                                   py_df <span class="op">=</span> <span class="va">nz_population</span>,</span>
<span>                                   age_width_df <span class="op">=</span> <span class="va">nz_age_width_df</span>,</span>
<span>                                   age_min <span class="op">=</span> <span class="fl">15</span>,</span>
<span>                                   byvar <span class="op">=</span> <span class="st">"sex"</span><span class="op">)</span></span>
<span><span class="va">res_agetime_vary</span></span>
<span><span class="co">#&gt; --- Object of class "BayesRates_results" ---</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;      nevent ~ Poisson(rate * py)</span></span>
<span><span class="co">#&gt;   log(rate) = age_effect + time_effect</span></span>
<span><span class="co">#&gt;  age_effect ~ Spline()</span></span>
<span><span class="co">#&gt; time_effect ~ TimeVarying()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    agevar: age</span></span>
<span><span class="co">#&gt;   timevar: time</span></span>
<span><span class="co">#&gt;     byvar: sex</span></span>
<span><span class="co">#&gt;    n_draw: 1000</span></span></code></pre></div>
<p>In this revised model, the systematic differences between modelled
and direct estimates disappear.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rates_agetime_vary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">res_agetime_vary</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rates_agetime_vary</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age.mid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span>, fill <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>,</span>
<span>              alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted</span>, color <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span>, color <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig1_nz_files/figure-html/unnamed-chunk-24-1.png" width="672"></p>
<p>Using the <code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code> function, we can extract the age
and age-time effects.</p>
<p>The age effect is an average age pattern over the whole period.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">age_effect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="va">res_agetime_vary</span>, what <span class="op">=</span> <span class="st">"age_effect"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">age_effect</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age.mid</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, y <span class="op">=</span> <span class="va">.fitted</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"salmon"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig1_nz_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<p>The age-time effect shows departures from the average effect in each
period</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time_effect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="va">res_agetime_vary</span>, what <span class="op">=</span> <span class="st">"time_effect"</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">time_effect</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age.mid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span>, fill <span class="op">=</span> <span class="va">sex</span><span class="op">)</span>,</span>
<span>              alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted</span>, color <span class="op">=</span> <span class="va">sex</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig1_nz_files/figure-html/unnamed-chunk-26-1.png" width="672"></p>
<p>The age-time effects rotate in an anti-clockwise direction. This
implies that the overall shellage-pattern is become more skewed towards
older ages over time.</p>
<p>Finally, we calculate time-varying total rates.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">total_varying</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/total_rate.html">total_rate</a></span><span class="op">(</span><span class="va">res_agetime_vary</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">total_varying</span>, </span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">.fitted</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">sex</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"salmon"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.observed</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vig1_nz_files/figure-html/unnamed-chunk-27-1.png" width="672"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by John Bryant, Junni Zhang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
